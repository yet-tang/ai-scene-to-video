# 本地部署指南

<cite>
**本文档引用的文件**  
- [docker-compose.coolify.yaml](file://docker-compose.coolify.yaml)
- [build.sh](file://build.sh)
- [.env.example](file://.env.example)
- [backend/Dockerfile](file://backend/Dockerfile)
- [engine/Dockerfile](file://engine/Dockerfile)
- [frontend/Dockerfile](file://frontend/Dockerfile)
- [backend/src/main/resources/application.yml](file://backend/src/main/resources/application.yml)
- [frontend/.env.example](file://frontend/.env.example)
- [COOLIFY_DEPLOY.md](file://COOLIFY_DEPLOY.md)
- [README.md](file://README.md)
</cite>

## 目录
1. [简介](#简介)
2. [本地开发环境准备](#本地开发环境准备)
3. [构建Docker镜像](#构建docker镜像)
4. [配置环境变量](#配置环境变量)
5. [启动服务](#启动服务)
6. [端口映射与访问](#端口映射与访问)
7. [服务健康检查](#服务健康检查)
8. [常见问题排查](#常见问题排查)
9. [附录：架构概览](#附录架构概览)

## 简介

本指南旨在为开发者提供完整的本地开发和测试部署流程，涵盖如何使用 `docker-compose.coolify.yaml` 文件启动整个系统，如何通过 `build.sh` 脚本构建后端、AI引擎和前端的Docker镜像，以及如何验证服务正常运行。同时提供环境配置、依赖准备和故障排查的详细说明。

**Section sources**
- [README.md](file://README.md#L1-L223)
- [COOLIFY_DEPLOY.md](file://COOLIFY_DEPLOY.md#L1-L99)

## 本地开发环境准备

在开始部署前，请确保本地已安装以下依赖：

- **Docker**：版本 20.10 或更高
- **Docker Compose**：版本 2.0 或更高
- **Git**：用于克隆项目
- **可选：Python 3.10+**：用于运行集成测试脚本

### 本地依赖服务准备

系统依赖 PostgreSQL 和 Redis 作为数据存储和缓存服务。建议使用 Docker 启动这些服务：

```bash
# 启动 PostgreSQL
docker run -d \
  --name ai-scene-postgres \
  -e POSTGRES_DB=ai_scene_db \
  -e POSTGRES_USER=ai_user \
  -e POSTGRES_PASSWORD=ai_password \
  -p 5432:5432 \
  postgres:15

# 启动 Redis
docker run -d \
  --name ai-scene-redis \
  -e REDIS_PASSWORD=redis_password \
  -p 6379:6379 \
  redis:7-alpine \
  redis-server --requirepass redis_password
```

**Section sources**
- [docker-compose.coolify.yaml](file://docker-compose.coolify.yaml#L4-L85)
- [COOLIFY_DEPLOY.md](file://COOLIFY_DEPLOY.md#L9-L11)

## 构建Docker镜像

项目提供 `build.sh` 脚本，用于依次构建后端、AI引擎和前端的Docker镜像。

### 构建流程说明

```bash
./build.sh
```

该脚本执行以下三个阶段：

1. **构建后端镜像**  
   使用 `backend/Dockerfile`，基于 Maven 多阶段构建，自动编译 Java 代码并打包为可执行 JAR。

2. **构建AI引擎镜像**  
   使用 `engine/Dockerfile`，安装 Python 依赖（包括 AI 相关库如 `dashscope`、`opencv`、`moviepy`），并设置 Celery Worker 为启动命令。

3. **构建前端镜像**  
   使用 `frontend/Dockerfile`，通过 Node.js 构建生产版本，并使用 Nginx 提供静态服务。

### 构建阶段作用

| 阶段 | 作用 | 源文件 |
|------|------|--------|
| 后端构建 | 编译 Spring Boot 应用，打包为 JAR | `backend/Dockerfile` |
| 引擎构建 | 安装 Python AI 依赖，配置 Celery 任务队列 | `engine/Dockerfile` |
| 前端构建 | 编译 Vue 应用，生成静态资源，配置 Nginx | `frontend/Dockerfile` |

**Section sources**
- [build.sh](file://build.sh#L1-L28)
- [backend/Dockerfile](file://backend/Dockerfile#L1-L14)
- [engine/Dockerfile](file://engine/Dockerfile#L1-L18)
- [frontend/Dockerfile](file://frontend/Dockerfile#L1-L25)

## 配置环境变量

项目使用 `.env` 文件管理环境变量。请根据 `.env.example` 创建本地 `.env` 文件。

### 关键配置参数

```env
# 数据库配置
SPRING_DATASOURCE_URL=jdbc:postgresql://localhost:5432/ai_scene_db
SPRING_DATASOURCE_USERNAME=ai_user
SPRING_DATASOURCE_PASSWORD=ai_password

# Redis 配置
SPRING_REDIS_URL=redis://default:redis_password@localhost:6379/0

# S3 存储配置（以 Cloudflare R2 为例）
S3_STORAGE_REGION=auto
S3_STORAGE_ENDPOINT=https://your-account-id.r2.cloudflarestorage.com
S3_STORAGE_ACCESS_KEY=your_access_key
S3_STORAGE_SECRET_KEY=your_secret_key
S3_STORAGE_BUCKET=ai-scene-assets
S3_STORAGE_PUBLIC_URL=https://pub-domain.r2.dev

# AI 服务密钥
DASHSCOPE_API_KEY=your_dashscope_api_key

# 引擎数据库连接（Python 格式 DSN）
DB_DSN=postgresql://ai_user:ai_password@localhost:5432/ai_scene_db

# 前端构建参数
VITE_API_BASE_URL=http://localhost:8090
VITE_API_KEY=optional_api_key
```

**Section sources**
- [.env.example](file://.env.example#L1-L25)
- [frontend/.env.example](file://frontend/.env.example#L1-L3)
- [docker-compose.coolify.yaml](file://docker-compose.coolify.yaml#L14-L58)

## 启动服务

完成镜像构建和环境配置后，使用以下命令启动所有服务：

```bash
docker-compose -f docker-compose.coolify.yaml up -d
```

此命令将启动以下三个服务：

- `ai-scene-backend`：Spring Boot 后端服务
- `ai-scene-engine`：Python AI 引擎（Celery Worker）
- `ai-scene-frontend`：Vue 前端（Nginx）

**Section sources**
- [docker-compose.coolify.yaml](file://docker-compose.coolify.yaml#L4-L85)
- [build.sh](file://build.sh#L26-L27)

## 端口映射与访问

各服务的端口映射如下：

| 服务 | 容器端口 | 主机端口 | 访问地址 |
|------|----------|----------|----------|
| 后端服务 | 8090 | 8090 | `http://localhost:8090` |
| 前端服务 | 80 | 3000 | `http://localhost:3000` |
| AI引擎 | 无暴露 | 无 | 无（内部通信） |

前端通过 `3000` 端口访问，后端 API 通过 `8090` 端口提供服务。

**Section sources**
- [docker-compose.coolify.yaml](file://docker-compose.coolify.yaml#L11,L76)

## 服务健康检查

系统已配置健康检查机制，可通过以下方式验证服务状态：

### 1. 查看容器状态

```bash
docker ps
```

确保三个容器均处于 `Up` 状态。

### 2. 检查后端健康接口

```bash
curl http://localhost:8090/health
```

预期返回：
```json
{"status":"UP"}
```

### 3. 查看日志

```bash
# 查看后端日志
docker logs ai-scene-backend

# 查看AI引擎日志
docker logs ai-scene-engine

# 查看前端日志
docker logs ai-scene-frontend
```

**Section sources**
- [docker-compose.coolify.yaml](file://docker-compose.coolify.yaml#L28-L32)
- [backend/src/main/resources/application.yml](file://backend/src/main/resources/application.yml#L34-L45)

## 常见问题排查

### 1. Docker 权限问题

**现象**：`permission denied` 或 `Cannot connect to the Docker daemon`

**解决方案**：
- 确保 Docker 服务已启动
- 将用户加入 `docker` 组：
  ```bash
  sudo usermod -aG docker $USER
  ```
  重新登录或重启终端。

### 2. 网络超时或依赖下载失败

**现象**：构建过程中 `apt-get` 或 `pip` 下载失败

**解决方案**：
- 配置国内镜像源：
  - **Python**：使用清华源
    ```bash
    pip install -r requirements.txt -i https://pypi.tuna.tsinghua.edu.cn/simple
    ```
  - **Node.js**：使用淘宝源
    ```bash
    npm config set registry https://registry.npmmirror.com
    ```
- 检查网络代理设置

### 3. 数据库连接失败

**现象**：后端或引擎启动时报错 `Connection refused`

**解决方案**：
- 确认 PostgreSQL 和 Redis 容器已启动
- 检查 `.env` 文件中的主机地址是否为 `localhost`（非容器内服务）
- 验证用户名、密码、数据库名是否正确

### 4. 构建缓存问题

**现象**：修改代码后构建未生效

**解决方案**：
- 清理构建缓存：
  ```bash
  docker builder prune
  ```
- 强制重建：
  ```bash
  docker-compose -f docker-compose.coolify.yaml build --no-cache
  ```

**Section sources**
- [COOLIFY_DEPLOY.md](file://COOLIFY_DEPLOY.md#L97-L99)
- [build.sh](file://build.sh#L2-L3)

## 附录架构概览

```mermaid
graph TB
subgraph "前端"
A[Vue.js 应用]
B[Nginx]
end
subgraph "后端"
C[Spring Boot]
D[PostgreSQL]
E[Redis]
end
subgraph "AI引擎"
F[Celery Worker]
G[DashScope API]
H[FFmpeg]
end
A --> C
C --> D
C --> E
C --> F
F --> G
F --> H
```

**Diagram sources**
- [README.md](file://README.md#L77-L95)
- [docker-compose.coolify.yaml](file://docker-compose.coolify.yaml#L4-L85)