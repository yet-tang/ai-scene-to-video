# 前端架构

<cite>
**本文档中引用的文件**  
- [main.ts](file://frontend/src/main.ts)
- [App.vue](file://frontend/src/App.vue)
- [router/index.ts](file://frontend/src/router/index.ts)
- [stores/project.ts](file://frontend/src/stores/project.ts)
- [api/client.ts](file://frontend/src/api/client.ts)
- [api/project.ts](file://frontend/src/api/project.ts)
- [views/CreateProject.vue](file://frontend/src/views/CreateProject.vue)
- [views/ProjectList.vue](file://frontend/src/views/ProjectList.vue)
- [views/ReviewTimeline.vue](file://frontend/src/views/ReviewTimeline.vue)
- [vite.config.ts](file://frontend/vite.config.ts)
- [package.json](file://frontend/package.json)
</cite>

## 目录
1. [项目结构](#项目结构)
2. [核心架构设计](#核心架构设计)
3. [状态管理](#状态管理)
4. [API客户端设计](#api客户端设计)
5. [核心视图组件](#核心视图组件)
6. [UI组件库与交互](#ui组件库与交互)
7. [组件通信与数据流](#组件通信与数据流)
8. [开发最佳实践](#开发最佳实践)

## 项目结构

前端应用采用基于Vue 3和TypeScript的标准Vite项目结构，遵循模块化设计原则。项目入口为`main.ts`，通过`App.vue`作为根组件，结合Vue Router实现路由控制，Pinia管理全局状态。

```mermaid
graph TB
A[main.ts] --> B[App.vue]
B --> C[Vue Router]
C --> D[CreateProject.vue]
C --> E[ProjectList.vue]
C --> F[ReviewTimeline.vue]
C --> G[ProjectDetail.vue]
C --> H[VideoResult.vue]
A --> I[Pinia Store]
I --> J[project.ts]
A --> K[Vant UI]
J --> L[API Client]
L --> M[client.ts]
L --> N[project.ts]
```

**Diagram sources**  
- [main.ts](file://frontend/src/main.ts#L1-L15)
- [App.vue](file://frontend/src/App.vue#L1-L15)
- [router/index.ts](file://frontend/src/router/index.ts#L1-L45)

**Section sources**
- [main.ts](file://frontend/src/main.ts#L1-L16)
- [App.vue](file://frontend/src/App.vue#L1-L15)
- [router/index.ts](file://frontend/src/router/index.ts#L1-L45)

## 核心架构设计

项目采用MVVM（Model-View-ViewModel）架构模式，基于Vue 3的Composition API和TypeScript实现。Vite作为构建工具提供了快速的开发服务器和高效的生产构建，支持热模块替换（HMR）和按需编译。

```mermaid
classDiagram
class App {
+setup()
}
class Main {
+createApp()
+use(Pinia)
+use(Router)
+use(Vant)
+mount()
}
class ViteConfig {
+defineConfig()
+plugins : [vue()]
}
Main --> App : "创建"
Main --> ViteConfig : "使用"
App --> Router : "依赖"
App --> Pinia : "依赖"
App --> Vant : "依赖"
```

**Diagram sources**  
- [main.ts](file://frontend/src/main.ts#L1-L15)
- [vite.config.ts](file://frontend/vite.config.ts#L1-L8)
- [package.json](file://frontend/package.json#L1-L28)

**Section sources**
- [main.ts](file://frontend/src/main.ts#L1-L16)
- [vite.config.ts](file://frontend/vite.config.ts#L1-L8)
- [package.json](file://frontend/package.json#L1-L28)

## 状态管理

项目使用Pinia作为状态管理库，`project.ts` store集中管理项目创建、列表和详情等全局状态。store通过`defineStore`定义，使用`ref`响应式变量存储当前项目数据，并提供异步操作方法。

```mermaid
classDiagram
class ProjectStore {
+currentProject : Ref<Project>
+fetchProject(id : string) : Promise<void>
+fetchTimeline(id : string) : Promise<void>
+applyMockProject(id : string, status : string) : void
+applyMockTimeline(assetCount : number) : void
}
class Project {
+id : string
+title : string
+info : ProjectInfo
+assets : Asset[]
+script : string
+audioUrl : string
+finalVideoUrl : string
+status : string
+errorLog : string
}
class ProjectInfo {
+communityName : string
+layout : Layout
+area : number | undefined
+price : number | undefined
+sellingPoints : string[]
+remarks : string
}
class Asset {
+id : string
+url : string
+sceneLabel : string
+userLabel : string
+duration : number
+sortOrder : number
+sceneScore? : number
}
class Layout {
+room : number
+hall : number
+restroom : number
}
ProjectStore --> Project
Project --> ProjectInfo
Project --> Asset
ProjectInfo --> Layout
```

**Diagram sources**  
- [stores/project.ts](file://frontend/src/stores/project.ts#L1-L219)

**Section sources**
- [stores/project.ts](file://frontend/src/stores/project.ts#L1-L219)

## API客户端设计

API客户端设计采用分层架构，`client.ts`封装axios实例，统一处理请求、响应和错误。`project.ts` API模块基于client构建，提供类型安全的项目相关操作接口。

```mermaid
sequenceDiagram
participant Component as "视图组件"
participant API as "project.ts API"
participant Client as "client.ts"
participant Axios as "axios"
participant Server as "后端服务"
Component->>API : 调用API方法
API->>Client : 发送HTTP请求
Client->>Axios : 创建请求
Axios->>Server : 发送请求
Server-->>Axios : 返回响应
Axios-->>Client : 处理响应
Client-->>API : 返回数据
API-->>Component : 返回结果
Note over Client,Server : 请求拦截器添加Authorization头
Note over Client,Server : 响应拦截器处理错误
```

**Diagram sources**  
- [api/client.ts](file://frontend/src/api/client.ts#L1-L36)
- [api/project.ts](file://frontend/src/api/project.ts#L1-L111)

**Section sources**
- [api/client.ts](file://frontend/src/api/client.ts#L1-L36)
- [api/project.ts](file://frontend/src/api/project.ts#L1-L111)

## 核心视图组件

### CreateProject.vue 组件

`CreateProject.vue`组件负责项目创建流程，包含基础信息、核心卖点和素材上传三个主要部分。组件使用Vant的表单组件收集用户输入，并通过API提交项目创建请求。

```mermaid
flowchart TD
A[开始] --> B[填写基础信息]
B --> C[选择核心卖点]
C --> D[上传素材视频]
D --> E[验证输入]
E --> F{输入有效?}
F --> |是| G[创建项目]
F --> |否| H[显示错误]
G --> I[获取预签名URL]
I --> J[上传视频到S3]
J --> K[确认资产]
K --> L[跳转到ReviewTimeline]
H --> B
```

**Diagram sources**  
- [views/CreateProject.vue](file://frontend/src/views/CreateProject.vue#L1-L534)

**Section sources**
- [views/CreateProject.vue](file://frontend/src/views/CreateProject.vue#L1-L534)

### ProjectList.vue 组件

`ProjectList.vue`组件展示项目列表，支持下拉刷新和分页加载。组件通过`van-pull-refresh`和`van-list`实现流畅的滚动加载体验，并提供浮动按钮快速创建新项目。

```mermaid
sequenceDiagram
participant List as "ProjectList.vue"
participant API as "projectApi.list"
participant Store as "projectStore"
List->>API : 请求项目列表
API-->>List : 返回项目数据
List->>Store : 更新状态
List->>List : 渲染列表
List->>List : 显示加载更多
List->>API : 加载下一页
```

**Diagram sources**  
- [views/ProjectList.vue](file://frontend/src/views/ProjectList.vue#L1-L143)

**Section sources**
- [views/ProjectList.vue](file://frontend/src/views/ProjectList.vue#L1-L143)

### ReviewTimeline.vue 组件

`ReviewTimeline.vue`组件提供视频时间线的确认和编辑功能，支持拖拽排序、场景标签修正和解说词编辑。组件通过轮询机制实时获取AI分析进度。

```mermaid
flowchart TD
A[加载项目] --> B{是否完成分析?}
B --> |否| C[显示分析进度]
B --> |是| D[显示时间线]
C --> E[轮询获取时间线]
E --> F{有更新?}
F --> |是| G[合并新资产]
F --> |否| E
G --> H[更新UI]
D --> I[拖拽排序]
I --> J[保存排序]
D --> K[编辑场景标签]
K --> L[保存标签]
D --> M[生成解说词]
M --> N[生成视频]
```

**Diagram sources**  
- [views/ReviewTimeline.vue](file://frontend/src/views/ReviewTimeline.vue#L1-L800)

**Section sources**
- [views/ReviewTimeline.vue](file://frontend/src/views/ReviewTimeline.vue#L1-L800)

## UI组件库与交互

项目集成Vant UI组件库，提供一致的移动端用户体验。`vuedraggable`用于实现时间线片段的拖拽排序功能，通过`draggable`组件和`v-model`实现双向数据绑定。

```mermaid
classDiagram
class VantComponents {
+van-nav-bar
+van-form
+van-field
+van-button
+van-cell
+van-list
+van-pull-refresh
+van-popup
+van-picker
+van-tag
+van-loading
}
class Vuedraggable {
+v-model
+item-key
+handle
+@end
+animation
+ghost-class
}
class ReviewTimeline {
+使用 VantComponents
+使用 Vuedraggable
}
ReviewTimeline --> VantComponents
ReviewTimeline --> Vuedraggable
```

**Diagram sources**  
- [views/ReviewTimeline.vue](file://frontend/src/views/ReviewTimeline.vue#L71-L79)
- [package.json](file://frontend/package.json#L1-L28)

**Section sources**
- [views/ReviewTimeline.vue](file://frontend/src/views/ReviewTimeline.vue#L71-L79)
- [package.json](file://frontend/package.json#L1-L28)

## 组件通信与状态同步

组件间通过Pinia store进行状态同步，避免了深层嵌套的prop传递。视图组件通过调用store的action方法触发状态变更，同时监听store的响应式数据实现UI更新。

```mermaid
sequenceDiagram
participant Create as "CreateProject.vue"
participant Review as "ReviewTimeline.vue"
participant Store as "projectStore"
Create->>Store : fetchProject()
Store->>API : getProject()
API-->>Store : 返回数据
Store-->>Create : 更新currentProject
Create->>Store : fetchTimeline()
Store->>API : getTimeline()
API-->>Store : 返回时间线
Store-->>Create : 更新assets
Create->>Review : 路由跳转
Review->>Store : 监听currentProject
Store-->>Review : 响应式更新
```

**Diagram sources**  
- [stores/project.ts](file://frontend/src/stores/project.ts#L66-L102)
- [views/CreateProject.vue](file://frontend/src/views/CreateProject.vue#L257-L325)
- [views/ReviewTimeline.vue](file://frontend/src/views/ReviewTimeline.vue#L296-L316)

**Section sources**
- [stores/project.ts](file://frontend/src/stores/project.ts#L66-L102)
- [views/CreateProject.vue](file://frontend/src/views/CreateProject.vue#L257-L325)
- [views/ReviewTimeline.vue](file://frontend/src/views/ReviewTimeline.vue#L296-L316)

## 开发最佳实践

1. **类型安全**：使用TypeScript定义接口，确保API响应和状态结构的类型安全
2. **模块化设计**：将API调用、状态管理、视图组件分离，提高代码可维护性
3. **错误处理**：在API客户端和视图组件中实现统一的错误处理机制
4. **性能优化**：使用Vite的按需编译和HMR，提高开发效率
5. **用户体验**：通过加载状态、进度指示和错误提示提升用户体验
6. **代码复用**：通过Pinia store实现跨组件状态共享，避免重复请求

**Section sources**
- [main.ts](file://frontend/src/main.ts#L1-L16)
- [api/client.ts](file://frontend/src/api/client.ts#L1-L36)
- [stores/project.ts](file://frontend/src/stores/project.ts#L1-L219)
- [views/CreateProject.vue](file://frontend/src/views/CreateProject.vue#L1-L534)
- [views/ReviewTimeline.vue](file://frontend/src/views/ReviewTimeline.vue#L1-L800)