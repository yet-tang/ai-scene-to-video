# 上传流程

<cite>
**本文档引用的文件**
- [ProjectService.java](file://backend/src/main/java/com/aiscene/service/ProjectService.java)
- [StorageService.java](file://backend/src/main/java/com/aiscene/service/StorageService.java)
- [Asset.java](file://backend/src/main/java/com/aiscene/entity/Asset.java)
- [AssetRepository.java](file://backend/src/main/java/com/aiscene/repository/AssetRepository.java)
- [TaskQueueService.java](file://backend/src/main/java/com/aiscene/service/TaskQueueService.java)
- [ProjectController.java](file://backend/src/main/java/com/aiscene/controller/ProjectController.java)
- [PresignedUrlResponse.java](file://backend/src/main/java/com/aiscene/dto/PresignedUrlResponse.java)
- [AssetConfirmRequest.java](file://backend/src/main/java/com/aiscene/dto/AssetConfirmRequest.java)
- [S3StorageConfig.java](file://backend/src/main/java/com/aiscene/config/S3StorageConfig.java)
- [V5__add_storage_fields_to_assets.sql](file://backend/src/main/resources/db/migration/V5__add_storage_fields_to_assets.sql)
- [application.yml](file://backend/src/main/resources/application.yml)
</cite>

## 目录
1. [上传流程概述](#上传流程概述)
2. [预签名URL获取](#预签名url获取)
3. [素材上传(uploadAsset)](#素材上传uploadasset)
4. [素材确认(confirmAsset)](#素材确认confirmasset)
5. [用户标签更新(updateAsset)](#用户标签更新updateasset)
6. [核心实体与数据结构](#核心实体与数据结构)
7. [项目状态自动升级机制](#项目状态自动升级机制)
8. [AI分析任务触发](#ai分析任务触发)
9. [大文件上传支持](#大文件上传支持)
10. [存储权限配置](#存储权限配置)
11. [错误处理策略](#错误处理策略)

## 上传流程概述

本系统实现了完整的素材上传处理流程，包括预签名URL获取、文件上传、素材确认和用户标签更新等核心功能。上传流程通过ProjectService协调StorageService、AssetRepository和TaskQueueService等组件，确保文件安全存储、元数据持久化和后续AI分析任务的自动触发。

**Section sources**
- [ProjectService.java](file://backend/src/main/java/com/aiscene/service/ProjectService.java#L252-L318)
- [ProjectController.java](file://backend/src/main/java/com/aiscene/controller/ProjectController.java#L91-L103)

## 预签名URL获取

系统通过预签名URL机制实现安全的文件上传。前端首先调用`/v1/projects/{id}/assets/presign`接口获取预签名URL，然后直接将文件上传到对象存储，避免了通过后端中转大文件。

```mermaid
sequenceDiagram
participant 前端 as 前端应用
participant 后端 as 后端服务
participant 对象存储 as 对象存储(S3/R2)
前端->>后端 : POST /v1/projects/{id}/assets/presign<br/>包含filename和contentType
后端->>后端 : validateContentType()验证内容类型
后端->>后端 : 生成objectKey(UUID+filename)
后端->>后端 : 调用storageService.generatePresignedUrl()
后端->>对象存储 : 请求预签名上传URL
对象存储-->>后端 : 返回预签名URL和签名头
后端-->>前端 : 返回PresignedUrlResponse
前端->>对象存储 : 使用预签名URL直接上传文件
对象存储-->>前端 : 上传成功响应
```

**Diagram sources**
- [ProjectController.java](file://backend/src/main/java/com/aiscene/controller/ProjectController.java#L73-L82)
- [StorageService.java](file://backend/src/main/java/com/aiscene/service/StorageService.java#L42-L69)

## 素材上传(uploadAsset)

`uploadAsset`方法是直接上传模式的核心处理逻辑，当文件较小或前端选择直接上传时使用。

```mermaid
sequenceDiagram
participant 前端 as 前端应用
participant 后端 as 后端服务
participant 存储服务 as StorageService
participant 资产库 as AssetRepository
participant 任务队列 as TaskQueueService
前端->>后端 : POST /v1/projects/{id}/assets<br/>包含文件multipart/form-data
后端->>后端 : validateContentType()验证内容类型
后端->>后端 : 调用projectService.uploadAsset()
后端->>后端 : 检查项目状态，必要时升级为UPLOADING
后端->>存储服务 : 调用storageService.uploadFileAndReturnObject()
存储服务->>对象存储 : 执行S3 PutObject操作
对象存储-->>存储服务 : 上传成功
存储服务-->>后端 : 返回UploadedObject(包含objectKey和publicUrl)
后端->>后端 : 计算sortOrder值
后端->>后端 : 构建Asset实体
后端->>资产库 : 保存Asset到数据库
资产库-->>后端 : 返回已保存的Asset
后端->>任务队列 : 提交AI分析任务
任务队列-->>后端 : 任务提交成功
后端->>后端 : 检查并升级项目状态为ANALYZING
后端-->>前端 : 返回Asset响应
```

**Diagram sources**
- [ProjectService.java](file://backend/src/main/java/com/aiscene/service/ProjectService.java#L252-L283)
- [ProjectController.java](file://backend/src/main/java/com/aiscene/controller/ProjectController.java#L91-L96)

## 素材确认(confirmAsset)

`confirmAsset`方法用于预签名URL直传模式的确认流程，当文件已通过预签名URL直接上传到对象存储后调用。

```mermaid
sequenceDiagram
participant 前端 as 前端应用
participant 后端 as 后端服务
participant 资产库 as AssetRepository
participant 任务队列 as TaskQueueService
前端->>后端 : POST /v1/projects/{id}/assets/confirm<br/>包含objectKey等信息
后端->>后端 : validateContentType()验证内容类型
后端->>后端 : 调用projectService.confirmAsset()
后端->>后端 : 检查项目状态，必要时升级为UPLOADING
后端->>后端 : 调用storageService.getPublicUrl()获取公开URL
后端->>后端 : 查询现有素材数量确定sortOrder
后端->>后端 : 构建Asset实体
后端->>资产库 : 保存Asset到数据库
资产库-->>后端 : 返回已保存的Asset
后端->>任务队列 : 提交AI分析任务
任务队列-->>后端 : 任务提交成功
后端->>后端 : 检查并升级项目状态为ANALYZING
后端-->>前端 : 返回Asset响应
```

**Diagram sources**
- [ProjectService.java](file://backend/src/main/java/com/aiscene/service/ProjectService.java#L49-L83)
- [ProjectController.java](file://backend/src/main/java/com/aiscene/controller/ProjectController.java#L84-L88)

## 用户标签更新(updateAsset)

`updateAsset`方法允许用户更新素材的用户标签和排序顺序。

```mermaid
sequenceDiagram
participant 前端 as 前端应用
participant 后端 as 后端服务
participant 资产库 as AssetRepository
前端->>后端 : PUT /v1/projects/{projectId}/assets/{assetId}<br/>包含UpdateAssetRequest
后端->>后端 : 调用projectService.updateAsset()
后端->>资产库 : 根据ID查找Asset
资产库-->>后端 : 返回找到的Asset
后端->>后端 : 更新userLabel和sceneLabel(如果提供)
后端->>后端 : 更新sortOrder(如果提供)
后端->>资产库 : 保存更新后的Asset
资产库-->>后端 : 返回已更新的Asset
后端-->>前端 : 返回Asset响应
```

**Diagram sources**
- [ProjectService.java](file://backend/src/main/java/com/aiscene/service/ProjectService.java#L126-L141)
- [ProjectController.java](file://backend/src/main/java/com/aiscene/controller/ProjectController.java#L133-L137)

## 核心实体与数据结构

### Asset实体结构

```mermaid
erDiagram
ASSET {
uuid id PK
uuid project_id FK
string oss_url
string storage_type
string storage_bucket
string storage_key
string local_path
double duration
string scene_label
double scene_score
string user_label
int sortOrder
boolean is_deleted
}
PROJECT {
uuid id PK
long user_id
string title
jsonb house_info
varchar status
timestamp created_at
timestamp updated_at
}
ASSET ||--o{ PROJECT : "belongs to"
```

**Diagram sources**
- [Asset.java](file://backend/src/main/java/com/aiscene/entity/Asset.java#L11-L60)
- [V5__add_storage_fields_to_assets.sql](file://backend/src/main/resources/db/migration/V5__add_storage_fields_to_assets.sql#L1-L6)

### 存储信息持久化

当素材上传或确认时，以下存储信息被持久化到Asset实体中：

- **storageType**: 存储类型，固定为"S3"
- **storageBucket**: 存储桶名称，从StorageService获取
- **storageKey**: 对象键，唯一标识存储中的文件

```mermaid
classDiagram
class Asset {
+UUID id
+Project project
+String ossUrl
+String storageType = "S3"
+String storageBucket
+String storageKey
+String localPath
+Double duration
+String sceneLabel
+Double sceneScore
+String userLabel
+Integer sortOrder
+Boolean isDeleted = false
}
class Project {
+UUID id
+Long userId
+String title
+JsonNode houseInfo
+ProjectStatus status
+Timestamp createdAt
+Timestamp updatedAt
}
Asset --> Project : "belongsTo"
```

**Diagram sources**
- [Asset.java](file://backend/src/main/java/com/aiscene/entity/Asset.java#L11-L60)
- [ProjectService.java](file://backend/src/main/java/com/aiscene/service/ProjectService.java#L65-L68)

## sortOrder字段的自动递增逻辑

`sortOrder`字段用于确定素材在时间线中的显示顺序，其值基于项目中现有素材的数量自动确定。

```mermaid
flowchart TD
Start([开始 uploadAsset/confirmAsset]) --> CheckProjectStatus["检查项目状态"]
CheckProjectStatus --> IsDraft{"项目状态为DRAFT?"}
IsDraft --> |是| UpdateStatus["更新状态为UPLOADING"]
IsDraft --> |否| SkipStatusUpdate["跳过状态更新"]
UpdateStatus --> GetAssetCount["查询项目中未删除素材数量"]
SkipStatusUpdate --> GetAssetCount
GetAssetCount --> CalculateSortOrder["计算sortOrder = 查询结果数量"]
CalculateSortOrder --> CreateAsset["创建Asset实体<br/>sortOrder="]
CreateAsset --> SaveAsset["保存Asset到数据库"]
SaveAsset --> SubmitTask["提交AI分析任务"]
SubmitTask --> CheckProjectStatus2["检查项目状态"]
CheckProjectStatus2 --> ShouldAnalyze{"状态为DRAFT或UPLOADING?"}
ShouldAnalyze --> |是| UpdateStatus2["更新状态为ANALYZING"]
ShouldAnalyze --> |否| SkipStatusUpdate2["跳过状态更新"]
UpdateStatus2 --> End([结束])
SkipStatusUpdate2 --> End
```

**Diagram sources**
- [ProjectService.java](file://backend/src/main/java/com/aiscene/service/ProjectService.java#L61-L71)
- [ProjectService.java](file://backend/src/main/java/com/aiscene/service/ProjectService.java#L262-L270)

## 项目状态自动升级机制

上传过程中，项目状态会根据当前状态和上传情况自动升级：

```mermaid
stateDiagram-v2
[*] --> DRAFT
DRAFT --> UPLOADING : uploadAsset/confirmAsset<br/>且当前状态为DRAFT
UPLOADING --> ANALYZING : uploadAsset/confirmAsset<br/>且当前状态为DRAFT或UPLOADING
DRAFT --> ANALYZING : uploadAsset/confirmAsset<br/>且当前状态为DRAFT或UPLOADING
ANALYZING --> SCRIPT_GENERATING : generateScript()
SCRIPT_GENERATING --> SCRIPT_GENERATED : 脚本生成完成
SCRIPT_GENERATED --> AUDIO_GENERATING : generateAudio()
AUDIO_GENERATING --> RENDERING : renderVideo()
RENDERING --> COMPLETED : 渲染完成
[*] --> FAILED
DRAFT --> FAILED : 操作失败
UPLOADING --> FAILED : 上传失败
ANALYZING --> FAILED : 分析失败
SCRIPT_GENERATING --> FAILED : 脚本生成失败
AUDIO_GENERATING --> FAILED : 音频生成失败
RENDERING --> FAILED : 渲染失败
```

**Diagram sources**
- [ProjectService.java](file://backend/src/main/java/com/aiscene/service/ProjectService.java#L53-L56)
- [ProjectService.java](file://backend/src/main/java/com/aiscene/service/ProjectService.java#L78-L81)

## AI分析任务触发

上传完成后，系统通过Redis队列自动触发AI分析任务。

```mermaid
sequenceDiagram
participant ProjectService
participant TaskQueueService
participant Redis
participant CeleryWorker
ProjectService->>TaskQueueService : submitAnalysisTask()<br/>(projectId, assetId, videoUrl)
TaskQueueService->>TaskQueueService : 创建AnalyzeTaskDto
TaskQueueService->>TaskQueueService : 构建Celery任务消息
TaskQueueService->>Redis : 将消息推送到ai-video : celery队列
Redis-->>CeleryWorker : 消费任务
CeleryWorker->>CeleryWorker : 执行analyze_video_task
CeleryWorker->>对象存储 : 下载视频文件
CeleryWorker->>AI模型 : 执行视频分析
AI模型-->>CeleryWorker : 返回分析结果
CeleryWorker->>后端API : 调用回调更新素材信息
后端API->>资产库 : 更新sceneLabel、sceneScore等字段
```

**Diagram sources**
- [ProjectService.java](file://backend/src/main/java/com/aiscene/service/ProjectService.java#L75-L76)
- [TaskQueueService.java](file://backend/src/main/java/com/aiscene/service/TaskQueueService.java#L32-L62)

## 大文件上传支持

系统通过预签名URL直传模式支持大文件上传，避免了通过后端中转大文件。

```mermaid
flowchart TD
A[前端] --> B{文件大小}
B --> |小于10MB| C[直接上传模式<br/>POST /v1/projects/{id}/assets]
B --> |大于10MB| D[预签名URL直传模式]
D --> E[请求预签名URL]
E --> F[获取uploadUrl和signedHeaders]
F --> G[使用XMLHttpRequest直接上传到S3]
G --> H[监听上传进度]
H --> I[上传完成后调用confirmAsset]
I --> J[确认素材信息]
```

**Diagram sources**
- [ProjectController.java](file://backend/src/main/java/com/aiscene/controller/ProjectController.java#L73-L82)
- [CreateProject.vue](file://frontend/src/views/CreateProject.vue#L221-L254)

## 存储权限配置

系统通过AWS SDK配置安全的存储访问权限。

```mermaid
classDiagram
class S3StorageConfig {
+String region
+String endpoint
+String accessKey
+String secretKey
+S3Client s3Client()
+S3Presigner s3Presigner()
}
class StorageService {
+S3Client s3Client
+S3Presigner s3Presigner
+String bucketName
+String publicUrlBase
+PresignedUrlResponse generatePresignedUrl()
+String getPublicUrl()
+UploadedObject uploadFileAndReturnObject()
}
S3StorageConfig --> StorageService : "配置"
StorageService --> S3Client : "使用"
StorageService --> S3Presigner : "使用"
```

**Diagram sources**
- [S3StorageConfig.java](file://backend/src/main/java/com/aiscene/config/S3StorageConfig.java#L16-L60)
- [StorageService.java](file://backend/src/main/java/com/aiscene/service/StorageService.java#L25-L140)

## 错误处理策略

系统实现了多层次的错误处理机制，确保上传流程的稳定性和可靠性。

```mermaid
flowchart TD
A[上传请求] --> B{验证}
B --> C[Content-Type验证]
C --> |无效| D[返回400 Bad Request]
C --> |有效| E[调用业务逻辑]
E --> F{业务处理}
F --> G[StorageService异常]
G --> |捕获| H[记录错误日志]
H --> I[返回500 Internal Server Error]
F --> J[数据库操作异常]
J --> |捕获| K[事务回滚]
K --> L[返回500 Internal Server Error]
F --> M[任务队列异常]
M --> |捕获| N[记录错误日志]
N --> O[返回500 Internal Server Error]
F --> P[成功]
P --> Q[返回200 OK]
```

**Section sources**
- [StorageService.java](file://backend/src/main/java/com/aiscene/service/StorageService.java#L70-L73)
- [ProjectController.java](file://backend/src/main/java/com/aiscene/controller/ProjectController.java#L105-L115)
- [ProjectService.java](file://backend/src/main/java/com/aiscene/service/ProjectService.java#L252-L318)