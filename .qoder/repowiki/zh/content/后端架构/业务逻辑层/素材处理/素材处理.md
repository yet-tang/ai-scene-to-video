# 素材处理

<cite>
**本文档中引用的文件**  
- [StorageService.java](file://backend/src/main/java/com/aiscene/service/StorageService.java)
- [ProjectService.java](file://backend/src/main/java/com/aiscene/service/ProjectService.java)
- [Asset.java](file://backend/src/main/java/com/aiscene/entity/Asset.java)
- [ProjectController.java](file://backend/src/main/java/com/aiscene/controller/ProjectController.java)
- [S3StorageConfig.java](file://backend/src/main/java/com/aiscene/config/S3StorageConfig.java)
- [application.yml](file://backend/src/main/resources/application.yml)
- [TaskQueueService.java](file://backend/src/main/java/com/aiscene/service/TaskQueueService.java)
- [CreateProject.vue](file://frontend/src/views/CreateProject.vue)
</cite>

## 目录
1. [简介](#简介)
2. [核心处理流程](#核心处理流程)
3. [StorageService与S3存储交互机制](#storageservice与s3存储交互机制)
4. [Asset实体中sortOrder字段的自动递增逻辑](#asset实体中sortorder字段的自动递增逻辑)
5. [项目状态自动升级机制](#项目状态自动升级机制)
6. [大文件上传与断点续传最佳实践](#大文件上传与断点续传最佳实践)
7. [存储权限配置建议](#存储权限配置建议)

## 简介
本系统实现了从素材上传到视频生成的完整流程，涵盖素材上传(uploadAsset)、预签名URL生成、素材确认(confirmAsset)和用户标签更新(updateAsset)等核心功能。系统通过StorageService与MinIO/阿里云OSS等S3兼容存储服务进行交互，利用预签名URL实现前端直传，确保高效安全的文件上传机制。同时，系统通过sortOrder字段管理素材在时间线中的排序，并在上传过程中自动升级项目状态，确保流程的连贯性和状态的一致性。

## 核心处理流程

```mermaid
sequenceDiagram
participant 前端 as 前端应用
participant ProjectController as ProjectController
participant ProjectService as ProjectService
participant StorageService as StorageService
participant S3Client as S3Client
participant TaskQueueService as TaskQueueService
前端->>ProjectController : uploadAsset(项目ID, 文件)
ProjectController->>ProjectService : uploadAsset(项目ID, 文件)
ProjectService->>ProjectService : 检查项目状态
alt 项目状态为DRAFT
ProjectService->>ProjectService : 更新为UPLOADING
end
ProjectService->>StorageService : uploadFileAndReturnObject(文件)
StorageService->>S3Client : putObject(上传文件)
S3Client-->>StorageService : 上传成功
StorageService-->>ProjectService : 返回对象键和公共URL
ProjectService->>ProjectService : 计算sortOrder
ProjectService->>ProjectService : 创建Asset实体
ProjectService->>TaskQueueService : submitAnalysisTask(分析任务)
alt 项目状态为DRAFT或UPLOADING
ProjectService->>ProjectService : 更新为ANALYZING
end
ProjectService-->>ProjectController : 返回Asset
ProjectController-->>前端 : 返回Asset信息
```

**流程图来源**
- [ProjectService.java](file://backend/src/main/java/com/aiscene/service/ProjectService.java#L252-L284)
- [StorageService.java](file://backend/src/main/java/com/aiscene/service/StorageService.java#L118-L135)

**流程说明**
1. 前端调用`uploadAsset`接口上传文件
2. `ProjectController`接收请求并委托给`ProjectService`
3. `ProjectService`检查项目状态，若为DRAFT则更新为UPLOADING
4. 调用`StorageService`的`uploadFileAndReturnObject`方法上传文件
5. `StorageService`使用S3Client将文件上传到对象存储
6. 计算新的`sortOrder`值并创建Asset实体
7. 提交分析任务到任务队列
8. 若项目状态为DRAFT或UPLOADING，则更新为ANALYZING
9. 返回Asset信息给前端

**流程图来源**
- [ProjectService.java](file://backend/src/main/java/com/aiscene/service/ProjectService.java#L252-L284)
- [StorageService.java](file://backend/src/main/java/com/aiscene/service/StorageService.java#L118-L135)

## StorageService与S3存储交互机制

### 预签名URL生成

```mermaid
sequenceDiagram
participant 前端 as 前端应用
participant ProjectController as ProjectController
participant StorageService as StorageService
participant S3Presigner as S3Presigner
前端->>ProjectController : getPresignedUrl(项目ID, 文件名, 内容类型)
ProjectController->>StorageService : generatePresignedUrl(对象键, 内容类型)
StorageService->>S3Presigner : presignPutObject(预签名请求)
S3Presigner-->>StorageService : 返回预签名请求
StorageService->>StorageService : 构建响应对象
StorageService-->>ProjectController : 返回预签名URL响应
ProjectController-->>前端 : 返回上传URL和公共URL
```

**流程图来源**
- [ProjectController.java](file://backend/src/main/java/com/aiscene/controller/ProjectController.java#L73-L82)
- [StorageService.java](file://backend/src/main/java/com/aiscene/service/StorageService.java#L42-L69)

### 文件上传实现

```mermaid
classDiagram
class StorageService {
+String bucketName
+String publicUrlBase
+S3Client s3Client
+S3Presigner s3Presigner
+PresignedUrlResponse generatePresignedUrl(String, String)
+String getPublicUrl(String)
+String uploadFile(MultipartFile)
+UploadedObject uploadFileAndReturnObject(MultipartFile)
}
class S3Client {
+PutObjectResponse putObject(PutObjectRequest, RequestBody)
}
class S3Presigner {
+PresignedPutObjectRequest presignPutObject(PutObjectPresignRequest)
}
StorageService --> S3Client : 使用
StorageService --> S3Presigner : 使用
```

**类图来源**
- [StorageService.java](file://backend/src/main/java/com/aiscene/service/StorageService.java#L25-L141)
- [S3StorageConfig.java](file://backend/src/main/java/com/aiscene/config/S3StorageConfig.java#L17-L61)

### 公共URL生成逻辑

```mermaid
flowchart TD
A[开始] --> B{公共URL基础是否以/结尾?}
B --> |是| C[移除末尾/]
B --> |否| D[保持不变]
C --> E{是否以http://或https://开头?}
D --> E
E --> |否| F[添加https://前缀]
E --> |是| G[保持不变]
F --> H[解析URL]
G --> H
H --> I{路径是否包含bucket或host以bucket开头?}
I --> |是| J[返回 base + / + objectKey]
I --> |否| K{host是否包含r2.cloudflarestorage.com或amazonaws.com或localhost?}
K --> |是| L[返回 base + / + bucket + / + objectKey]
K --> |否| M[返回 base + / + objectKey]
```

**流程图来源**
- [StorageService.java](file://backend/src/main/java/com/aiscene/service/StorageService.java#L76-L102)

## Asset实体中sortOrder字段的自动递增逻辑

### 自动递增实现

```mermaid
sequenceDiagram
participant ProjectService as ProjectService
participant AssetRepository as AssetRepository
participant Asset as Asset
ProjectService->>AssetRepository : findByProjectIdAndIsDeletedFalseOrderBySortOrderAsc(项目ID)
AssetRepository-->>ProjectService : 返回已排序的Asset列表
ProjectService->>ProjectService : 计算列表大小作为nextSortOrder
ProjectService->>Asset : 创建新Asset
ProjectService->>Asset : 设置sortOrder为nextSortOrder
ProjectService->>AssetRepository : 保存Asset
```

**流程图来源**
- [ProjectService.java](file://backend/src/main/java/com/aiscene/service/ProjectService.java#L262-L271)
- [AssetRepository.java](file://backend/src/main/java/com/aiscene/repository/AssetRepository.java#L10-L14)

### 时间线排序作用

```mermaid
sequenceDiagram
participant ProjectService as ProjectService
participant AssetRepository as AssetRepository
participant TimelineResponse as TimelineResponse
ProjectService->>AssetRepository : findByProjectIdAndIsDeletedFalseOrderBySortOrderAsc(项目ID)
AssetRepository-->>ProjectService : 返回按sortOrder升序排列的Asset列表
ProjectService->>ProjectService : 检查是否有场景分析结果
alt 有分析结果
ProjectService->>ProjectService : 按场景优先级重新排序
end
ProjectService->>TimelineResponse : 构建响应对象
```

**流程图来源**
- [ProjectService.java](file://backend/src/main/java/com/aiscene/service/ProjectService.java#L86-L124)
- [AssetRepository.java](file://backend/src/main/java/com/aiscene/repository/AssetRepository.java#L10-L14)

## 项目状态自动升级机制

### 状态升级流程

```mermaid
stateDiagram-v2
[*] --> DRAFT
DRAFT --> UPLOADING : 上传第一个素材
UPLOADING --> ANALYZING : 提交分析任务
ANALYZING --> REVIEW : 分析完成
REVIEW --> SCRIPT_GENERATING : 生成脚本
SCRIPT_GENERATING --> SCRIPT_GENERATED : 脚本生成完成
SCRIPT_GENERATED --> AUDIO_GENERATING : 生成音频
AUDIO_GENERATING --> AUDIO_GENERATED : 音频生成完成
AUDIO_GENERATED --> RENDERING : 开始渲染
RENDERING --> COMPLETED : 渲染完成
DRAFT --> FAILED : 操作失败
UPLOADING --> FAILED : 上传失败
ANALYZING --> FAILED : 分析失败
SCRIPT_GENERATING --> FAILED : 脚本生成失败
AUDIO_GENERATING --> FAILED : 音频生成失败
RENDERING --> FAILED : 渲染失败
```

**状态图来源**
- [ProjectService.java](file://backend/src/main/java/com/aiscene/service/ProjectService.java#L53-L55)
- [ProjectService.java](file://backend/src/main/java/com/aiscene/service/ProjectService.java#L78-L81)
- [ProjectStatus.java](file://backend/src/main/java/com/aiscene/entity/ProjectStatus.java#L3-L15)

### 状态升级实现

```mermaid
flowchart TD
A[开始上传素材] --> B{项目状态是否为DRAFT?}
B --> |是| C[更新状态为UPLOADING]
B --> |否| D[保持当前状态]
C --> E[上传文件到S3]
D --> E
E --> F[创建Asset实体]
F --> G[提交分析任务]
G --> H{项目状态为DRAFT或UPLOADING?}
H --> |是| I[更新状态为ANALYZING]
H --> |否| J[保持当前状态]
I --> K[返回Asset信息]
J --> K
```

**流程图来源**
- [ProjectService.java](file://backend/src/main/java/com/aiscene/service/ProjectService.java#L253-L281)
- [ProjectService.java](file://backend/src/main/java/com/aiscene/service/ProjectService.java#L50-L83)

## 大文件上传与断点续传最佳实践

### 前端上传实现

```mermaid
sequenceDiagram
participant 前端 as 前端应用
participant ProjectController as ProjectController
participant StorageService as StorageService
participant S3Client as S3Client
前端->>ProjectController : getPresignedUrl(获取预签名URL)
ProjectController->>StorageService : generatePresignedUrl(生成预签名URL)
StorageService-->>ProjectController : 返回预签名URL
ProjectController-->>前端 : 返回上传URL
前端->>S3Client : 使用XMLHttpRequest上传文件
S3Client-->>前端 : 上传进度事件
前端->>前端 : 更新上传进度
S3Client-->>前端 : 上传完成
前端->>ProjectController : confirmAsset(确认素材)
```

**流程图来源**
- [CreateProject.vue](file://frontend/src/views/CreateProject.vue#L221-L254)
- [ProjectController.java](file://backend/src/main/java/com/aiscene/controller/ProjectController.java#L84-L89)

### 断点续传建议

```mermaid
flowchart TD
A[开始上传] --> B{文件大小 > 100MB?}
B --> |是| C[启用分片上传]
B --> |否| D[直接上传]
C --> E[计算分片大小]
E --> F[生成每个分片的预签名URL]
F --> G[并行上传分片]
G --> H[收集分片ETag]
H --> I[完成分片上传]
I --> J[合并分片]
D --> K[上传完整文件]
K --> L[返回结果]
J --> L
```

**流程图来源**
- [application.yml](file://backend/src/main/resources/application.yml#L26-L27)
- [StorageService.java](file://backend/src/main/java/com/aiscene/service/StorageService.java#L118-L135)

## 存储权限配置建议

### S3存储配置

```mermaid
classDiagram
class S3StorageConfig {
+String region
+String endpoint
+String accessKey
+String secretKey
+S3Client s3Client()
+S3Presigner s3Presigner()
}
class S3Client {
+region
+endpointOverride
+credentialsProvider
+forcePathStyle
}
class S3Presigner {
+region
+endpointOverride
+credentialsProvider
+serviceConfiguration
}
S3StorageConfig --> S3Client : 创建
S3StorageConfig --> S3Presigner : 创建
```

**类图来源**
- [S3StorageConfig.java](file://backend/src/main/java/com/aiscene/config/S3StorageConfig.java#L17-L61)
- [application.yml](file://backend/src/main/resources/application.yml#L50-L59)

### 安全配置建议

```mermaid
flowchart TD
A[环境变量配置] --> B[敏感信息不硬编码]
B --> C[使用预签名URL]
C --> D[限制URL有效期]
D --> E[设置内容类型白名单]
E --> F[验证上传文件类型]
F --> G[使用HTTPS传输]
G --> H[配置CORS策略]
H --> I[最小权限原则]
I --> J[定期轮换密钥]
```

**流程图来源**
- [application.yml](file://backend/src/main/resources/application.yml#L64-L65)
- [ProjectController.java](file://backend/src/main/java/com/aiscene/controller/ProjectController.java#L105-L116)
- [S3StorageConfig.java](file://backend/src/main/java/com/aiscene/config/S3StorageConfig.java#L32-L43)