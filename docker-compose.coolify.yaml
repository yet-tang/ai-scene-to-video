version: '3.8'

services:
  ai-scene-backend:
    build: 
      context: ./backend
      dockerfile: Dockerfile
    image: ai-scene-backend:latest
    container_name: ai-scene-backend
    ports:
      - "8090:8090"
    environment:
      - SERVER_PORT=8090
      - SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL}
      - SPRING_DATASOURCE_USERNAME=${SPRING_DATASOURCE_USERNAME}
      - SPRING_DATASOURCE_PASSWORD=${SPRING_DATASOURCE_PASSWORD}
      - SPRING_REDIS_URL=${SPRING_REDIS_URL}
      # S3 Storage Configuration
      - S3_STORAGE_REGION=${S3_STORAGE_REGION}
      - S3_STORAGE_ENDPOINT=${S3_STORAGE_ENDPOINT}
      - S3_STORAGE_ACCESS_KEY=${S3_STORAGE_ACCESS_KEY}
      - S3_STORAGE_SECRET_KEY=${S3_STORAGE_SECRET_KEY}
      - S3_STORAGE_BUCKET=${S3_STORAGE_BUCKET}
      - S3_STORAGE_PUBLIC_URL=${S3_STORAGE_PUBLIC_URL}
      - APP_DEV_RESET_ENABLED=${APP_DEV_RESET_ENABLED}
      - APP_UPLOAD_ALLOWED_CONTENT_TYPES=${APP_UPLOAD_ALLOWED_CONTENT_TYPES}
      # Built-in BGM Configuration
      - APP_BGM_AUTO_SELECT=${APP_BGM_AUTO_SELECT:-true}
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8090/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - coolify

  ai-scene-engine:
    build: 
      context: ./engine
      dockerfile: Dockerfile
    image: ai-scene-engine:latest
    container_name: ai-scene-engine
    environment:
      # Redis Connection (Same as backend)
      - REDIS_URL=${SPRING_REDIS_URL}
      # DB Connection (Engine constructs DSN from parts or uses full DSN if provided)
      # We recommend passing full DSN for simplicity in Coolify
      - DB_DSN=${DB_DSN} 
      # AI Service Keys
      - DASHSCOPE_API_KEY=${DASHSCOPE_API_KEY}
      - SMART_SPLIT_ENABLED=true
      - SMART_SPLIT_STRATEGY=hybrid
      - SMART_SPLIT_MIN_DURATION_SEC=10
      # "温情生活风" Enhancement Features
      # Subtitle Configuration
      - SUBTITLE_ENABLED=${SUBTITLE_ENABLED:-true}
      - SUBTITLE_FONT=${SUBTITLE_FONT:-Arial-Bold}
      - SUBTITLE_FONT_SIZE=${SUBTITLE_FONT_SIZE:-48}
      - SUBTITLE_POSITION=${SUBTITLE_POSITION:-0.75}
      - SUBTITLE_STYLE=${SUBTITLE_STYLE:-default}
      # Visual Enhancement (Aliyun Wanxiang)
      - VISUAL_ENHANCEMENT_ENABLED=${VISUAL_ENHANCEMENT_ENABLED:-false}
      - VISUAL_ENHANCEMENT_STRATEGY=${VISUAL_ENHANCEMENT_STRATEGY:-smart}
      - VISUAL_ENHANCEMENT_MODEL=${VISUAL_ENHANCEMENT_MODEL:-wanx2.1-vace-plus}
      # Sound Effects (SFX)
      - SFX_ENABLED=${SFX_ENABLED:-false}
      - SFX_LIBRARY_PATH=${SFX_LIBRARY_PATH:-/app/sfx_library}
      # Audio Mixing & BGM
      - AUTO_DUCKING_ENABLED=${AUTO_DUCKING_ENABLED:-false}
      - BGM_VOLUME=${BGM_VOLUME:-0.15}
      - BGM_DUCKING_LEVEL=${BGM_DUCKING_LEVEL:-0.3}
      # Performance Optimization
      - RENDER_THREADS=${RENDER_THREADS:-4}
      - ENABLE_CLIP_CACHE=${ENABLE_CLIP_CACHE:-false}
      - MAX_VIDEO_RESOLUTION=${MAX_VIDEO_RESOLUTION:-1080}
      # S3 Configuration (For uploading final video)
      - S3_STORAGE_REGION=${S3_STORAGE_REGION}
      - S3_STORAGE_ENDPOINT=${S3_STORAGE_ENDPOINT}
      - S3_STORAGE_ACCESS_KEY=${S3_STORAGE_ACCESS_KEY}
      - S3_STORAGE_SECRET_KEY=${S3_STORAGE_SECRET_KEY}
      - S3_STORAGE_BUCKET=${S3_STORAGE_BUCKET}
      - S3_STORAGE_PUBLIC_URL=${S3_STORAGE_PUBLIC_URL}
    restart: always
    depends_on:
      - ai-scene-backend
    networks:
      - coolify

  ai-scene-frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        - VITE_API_BASE_URL=${VITE_API_BASE_URL}
        - VITE_API_KEY=${VITE_API_KEY}
    image: ai-scene-frontend:latest
    container_name: ai-scene-frontend
    ports:
      - "3000:80"
    restart: always
    depends_on:
      - ai-scene-backend
    networks:
      - coolify

networks:
  coolify:
    external: true
