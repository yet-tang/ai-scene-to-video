version: '3.8'

services:
  ai-scene-backend:
    image: ${DOCKER_REGISTRY:-ghcr.io}/${DOCKER_IMAGE_PREFIX:-ai-scene}-backend:${IMAGE_TAG:-latest}
    pull_policy: always  # 强制每次拉取最新镜像
    container_name: ai-scene-backend
    ports:
      - "8090:8090"
    environment:
      - SERVER_PORT=8090
      - SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL}
      - SPRING_DATASOURCE_USERNAME=${SPRING_DATASOURCE_USERNAME}
      - SPRING_DATASOURCE_PASSWORD=${SPRING_DATASOURCE_PASSWORD}
      - SPRING_REDIS_URL=${SPRING_REDIS_URL}
      # S3 Storage Configuration
      - S3_STORAGE_REGION=${S3_STORAGE_REGION}
      - S3_STORAGE_ENDPOINT=${S3_STORAGE_ENDPOINT}
      - S3_STORAGE_ACCESS_KEY=${S3_STORAGE_ACCESS_KEY}
      - S3_STORAGE_SECRET_KEY=${S3_STORAGE_SECRET_KEY}
      - S3_STORAGE_BUCKET=${S3_STORAGE_BUCKET}
      - S3_STORAGE_PUBLIC_URL=${S3_STORAGE_PUBLIC_URL}
      - APP_DEV_RESET_ENABLED=${APP_DEV_RESET_ENABLED}
      - APP_UPLOAD_ALLOWED_CONTENT_TYPES=${APP_UPLOAD_ALLOWED_CONTENT_TYPES}
      # Built-in BGM Configuration
      - APP_BGM_AUTO_SELECT=${APP_BGM_AUTO_SELECT:-true}
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8090/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    networks:
      - coolify

  ai-scene-engine:
    image: ${DOCKER_REGISTRY:-ghcr.io}/${DOCKER_IMAGE_PREFIX:-ai-scene}-engine:${IMAGE_TAG:-latest}
    pull_policy: always  # 强制每次拉取最新镜像
    container_name: ai-scene-engine
    environment:
      # Redis Connection (Same as backend)
      - REDIS_URL=${SPRING_REDIS_URL}
      # DB Connection (Engine constructs DSN from parts or uses full DSN if provided)
      # We recommend passing full DSN for simplicity in Coolify
      - DB_DSN=${DB_DSN} 
      # AI Service Keys
      - DASHSCOPE_API_KEY=${DASHSCOPE_API_KEY}
      - GROK_API_KEY=${GROK_API_KEY:-}
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}
      - OPENAI_API_KEY=${OPENAI_API_KEY:-}
      - VOLCENGINE_API_KEY=${VOLCENGINE_API_KEY:-}
      # LLM Strategy Configuration
      - LLM_COST_AWARE_ROUTING=${LLM_COST_AWARE_ROUTING:-true}
      - LLM_MAX_RETRIES=${LLM_MAX_RETRIES:-3}
      - LLM_RETRY_DELAY=${LLM_RETRY_DELAY:-1}
      - SMART_SPLIT_ENABLED=true
      - SMART_SPLIT_STRATEGY=hybrid
      - SMART_SPLIT_MIN_DURATION_SEC=10
      # "温情生活风" Enhancement Features
      # Subtitle Configuration
      - SUBTITLE_ENABLED=${SUBTITLE_ENABLED:-true}
      - SUBTITLE_FONT=${SUBTITLE_FONT:-Arial-Bold}
      - SUBTITLE_FONT_SIZE=${SUBTITLE_FONT_SIZE:-48}
      - SUBTITLE_POSITION=${SUBTITLE_POSITION:-0.75}
      - SUBTITLE_STYLE=${SUBTITLE_STYLE:-default}
      # Visual Enhancement (Aliyun Wanxiang)
      - VISUAL_ENHANCEMENT_ENABLED=${VISUAL_ENHANCEMENT_ENABLED:-false}
      - VISUAL_ENHANCEMENT_STRATEGY=${VISUAL_ENHANCEMENT_STRATEGY:-smart}
      - VISUAL_ENHANCEMENT_MODEL=${VISUAL_ENHANCEMENT_MODEL:-wanx2.1-vace-plus}
      # Sound Effects (SFX)
      - SFX_ENABLED=${SFX_ENABLED:-false}
      - SFX_LIBRARY_PATH=${SFX_LIBRARY_PATH:-/app/sfx_library}
      # Audio Mixing & BGM
      - AUTO_DUCKING_ENABLED=${AUTO_DUCKING_ENABLED:-false}
      - BGM_VOLUME=${BGM_VOLUME:-0.15}
      - BGM_DUCKING_LEVEL=${BGM_DUCKING_LEVEL:-0.3}
      # Performance Optimization
      - RENDER_THREADS=${RENDER_THREADS:-4}
      - ENABLE_CLIP_CACHE=${ENABLE_CLIP_CACHE:-false}
      - MAX_VIDEO_RESOLUTION=${MAX_VIDEO_RESOLUTION:-1080}
      # Celery Worker Concurrency (for 4GB VPS, recommend 2)
      - CELERY_WORKER_CONCURRENCY=${CELERY_WORKER_CONCURRENCY:-2}
      # S3 Configuration (For uploading final video)
      - S3_STORAGE_REGION=${S3_STORAGE_REGION}
      - S3_STORAGE_ENDPOINT=${S3_STORAGE_ENDPOINT}
      - S3_STORAGE_ACCESS_KEY=${S3_STORAGE_ACCESS_KEY}
      - S3_STORAGE_SECRET_KEY=${S3_STORAGE_SECRET_KEY}
      - S3_STORAGE_BUCKET=${S3_STORAGE_BUCKET}
      - S3_STORAGE_PUBLIC_URL=${S3_STORAGE_PUBLIC_URL}
    restart: always
    depends_on:
      - ai-scene-backend
    networks:
      - coolify

  ai-scene-frontend:
    image: ${DOCKER_REGISTRY:-ghcr.io}/${DOCKER_IMAGE_PREFIX:-ai-scene}-frontend:${IMAGE_TAG:-latest}
    pull_policy: always  # 强制每次拉取最新镜像
    environment:
      # Frontend build args are baked into the image during GitHub Actions build
      # These env vars are for runtime reference only (not used by Nginx)
      - VITE_API_BASE_URL=${VITE_API_BASE_URL}
      - VITE_API_KEY=${VITE_API_KEY}
    container_name: ai-scene-frontend
    ports:
      - "3000:80"
    restart: always
    depends_on:
      - ai-scene-backend
    networks:
      - coolify

  # Admin Management Services
  admin-backend:
    image: ${DOCKER_REGISTRY:-ghcr.io}/${DOCKER_IMAGE_PREFIX:-ai-scene}-admin-backend:${IMAGE_TAG:-latest}
    pull_policy: always  # 强制每次拉取最新镜像
    container_name: admin-backend
    ports:
      - "8091:8091"
    environment:
      - SERVER_PORT=8091
      # Database - shares same database as main backend
      - SPRING_DATASOURCE_URL=${SPRING_DATASOURCE_URL}
      - SPRING_DATASOURCE_USERNAME=${SPRING_DATASOURCE_USERNAME}
      - SPRING_DATASOURCE_PASSWORD=${SPRING_DATASOURCE_PASSWORD}
      # Redis
      - SPRING_REDIS_URL=${SPRING_REDIS_URL}
      # JWT Configuration
      - JWT_SECRET=${ADMIN_JWT_SECRET}
      - JWT_EXPIRATION=${ADMIN_JWT_EXPIRATION:-86400000}
      # Flower URL for Celery monitoring
      - ADMIN_FLOWER_BASE_URL=${ADMIN_FLOWER_BASE_URL:-http://flower:5555}
    restart: always
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8091/health"]
      interval: 30s
      timeout: 10s
      retries: 3
    depends_on:
      - ai-scene-backend
    networks:
      - coolify

  admin-frontend:
    image: ${DOCKER_REGISTRY:-ghcr.io}/${DOCKER_IMAGE_PREFIX:-ai-scene}-admin-frontend:${IMAGE_TAG:-latest}
    pull_policy: always  # 强制每次拉取最新镜像
    container_name: admin-frontend
    ports:
      - "3001:80"
    restart: always
    depends_on:
      - admin-backend
    networks:
      - coolify

  # Flower - Celery monitoring dashboard
  flower:
    image: mher/flower:2.0
    container_name: flower
    ports:
      - "5555:5555"
    environment:
      - CELERY_BROKER_URL=${SPRING_REDIS_URL}
      - FLOWER_PORT=5555
      - FLOWER_BASIC_AUTH=${FLOWER_BASIC_AUTH:-admin:admin}
    restart: always
    depends_on:
      - ai-scene-engine
    networks:
      - coolify

networks:
  coolify:
    external: true
