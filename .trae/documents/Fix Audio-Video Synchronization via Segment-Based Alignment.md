# 修复音画不同步问题（SSML分布式对齐版）

基于您的深度反馈，我们将实施基于 SSML 的精细化对齐策略，通过分布式插入静音和文本级优化来实现广播级同步。

## 1. 引擎：基于「时长预算」的脚本生成
- 修改 `engine/script_gen.py`：
  - **预算计算**：根据视频片段时长，按 `4字/秒` 预估字数上限（Time Budget）。
  - **Prompt 增强**：在提示词中显式注入预算约束，例如 `片段1 (5s, 限20字)`，强制 LLM 输出精简脚本。
  - **结构化输出**：返回 JSON 格式，包含 `text` 和 `asset_id`。

## 2. 引擎：SSML 分布式对齐 (SSML Distributed Alignment)
- 修改 `engine/audio_gen.py`，实现精细的时长控制逻辑：
  - **场景 A：视频过长（Video > Audio）- 分布式静音插入**
    - 计算需要填充的静音总时长 `Delta = Video - Audio`。
    - **分布式策略**：识别文本中的标点符号（逗号、句号）。将 `Delta` 均匀或按权重（句号>逗号）分配到这些标点位置。
    - **SSML 生成**：构造包含 `<break time="Xms"/>` 的 SSML 代码，重新合成音频，使解说自然延展，填满画面。
  - **场景 B：视频过短（Video < Audio）- 文本级收缩与加速**
    - **文本级收缩 (Level 1)**：通过 SSML 缩短标点间的默认停顿（例如将句号默认停顿压缩至最小值）。
    - **语速提升 (Level 2)**：如果仍超时，提高 TTS 的 `speech_rate`（语速），限制在 1.25 倍以内。
    - **极端情况**：如果上述手段无效，标记该片段，交由视频渲染层处理。

## 3. 引擎：兜底视频渲染
- 修改 `engine/video_render.py`：
  - 接收已尽力对齐的音频片段。
  - 对于仍无法匹配的极端“短视频长解说”片段，自动应用 **镜像循环 (Boomerang)** 效果，物理延长视频以保证解说完整。

## 4. 任务编排
- 更新 `engine/tasks.py` 以支持新的数据流和参数传递。

## 5. 前端：增强显示
- 更新 `frontend/src/views/ReviewTimeline.vue`，在脚本编辑框显示“预算字数”，辅助用户手动微调。
